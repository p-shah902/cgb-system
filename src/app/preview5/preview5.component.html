<!-- Toasts Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <ngb-toast *ngFor="let toast of toastService.toasts" [class]="'bg-' + toast.type" [autohide]="true" [delay]="5000"
             (hidden)="toastService.remove(toast)">
    {{ toast.message }}
  </ngb-toast>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-xl-12">
      <div class="form-main-div">
        <div class="form-header sticky-header mb-4">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="d-flex gap-3 align-items-center">
                <div class="form-group mb-3 mb-sm-3 mb-md-0">
                  <select #sectionDropdown class="form-control" (change)="scrollToSection($event)">
                    <option value="section1">1. General Information</option>
                    <option value="section2">2. Cost Allocation and JV Approval</option>
                    <option value="section3">3. Consultation</option>
                    <option value="section4">4. Attachments</option>
                  </select>
                </div>
                <div class="fh-search">
                  <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M16 14H15.21L14.93 13.73C15.91 12.59 16.5 11.11 16.5 9.5C16.5 5.91 13.59 3 10 3C6.41 3 3.5 5.91 3.5 9.5C3.5 13.09 6.41 16 10 16C11.61 16 13.09 15.41 14.23 14.43L14.5 14.71V15.5L19.5 20.49L20.99 19L16 14ZM10 14C7.51 14 5.5 11.99 5.5 9.5C5.5 7.01 7.51 5 10 5C12.49 5 14.5 7.01 14.5 9.5C14.5 11.99 12.49 14 10 14Z"
                          fill="#84818A"/>
                  </svg>
                  <input type="text" class="form-control" placeholder="Search field" (input)="onSearch($event.target)">
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="fh-action d-flex gap-3 justify-content-end">
                <button class="btn btn-light">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M0.599976 9L0.0428889 8.77717C-0.0143289 8.92021 -0.0143289 9.07979 0.0428889 9.22283L0.599976 9ZM17.4 9L17.9571 9.22284C18.0143 9.07979 18.0143 8.92021 17.9571 8.77716L17.4 9ZM8.99996 14.4C6.22314 14.4 4.27331 13.0179 2.99594 11.5986C2.35684 10.8885 1.89371 10.1764 1.59074 9.64169C1.43959 9.37496 1.32924 9.15406 1.25753 9.00196C1.22171 8.92596 1.19559 8.86728 1.17893 8.82882C1.1706 8.80959 1.16463 8.79543 1.161 8.7867C1.15918 8.78233 1.15795 8.77932 1.15729 8.77772C1.15696 8.77692 1.15678 8.77647 1.15674 8.77637C1.15672 8.77633 1.15674 8.77637 1.15679 8.7765C1.15682 8.77657 1.15689 8.77673 1.1569 8.77677C1.15698 8.77696 1.15706 8.77717 0.599976 9C0.0428889 9.22283 0.0429921 9.22309 0.0431045 9.22337C0.0431543 9.2235 0.0432763 9.2238 0.0433761 9.22405C0.0435758 9.22454 0.0438129 9.22513 0.0440875 9.22581C0.0446365 9.22717 0.0453354 9.2289 0.0461847 9.23098C0.0478833 9.23514 0.0501837 9.24074 0.0530909 9.24773C0.0589049 9.2617 0.0671483 9.28123 0.0778593 9.30595C0.0992775 9.35537 0.130588 9.4256 0.172103 9.51366C0.255086 9.68969 0.379109 9.93754 0.546709 10.2333C0.881233 10.8236 1.3931 11.6115 2.10399 12.4014C3.52661 13.9821 5.77677 15.6 8.99996 15.6V14.4ZM0.599976 9C1.15706 9.22283 1.15698 9.22305 1.1569 9.22323C1.15689 9.22327 1.15682 9.22343 1.15679 9.2235C1.15674 9.22363 1.15672 9.22367 1.15674 9.22363C1.15678 9.22353 1.15696 9.22308 1.15729 9.22228C1.15795 9.22068 1.15918 9.21767 1.161 9.2133C1.16463 9.20457 1.1706 9.19041 1.17893 9.17118C1.19559 9.13272 1.22171 9.07404 1.25753 8.99804C1.32924 8.84594 1.43959 8.62504 1.59074 8.35831C1.89371 7.82365 2.35684 7.1115 2.99594 6.40138C4.27331 4.98208 6.22314 3.6 8.99996 3.6V2.4C5.77677 2.4 3.52661 4.01792 2.10399 5.59862C1.3931 6.3885 0.881233 7.17635 0.546709 7.76669C0.379109 8.06246 0.255086 8.31031 0.172103 8.48634C0.130588 8.5744 0.0992775 8.64463 0.0778593 8.69405C0.0671483 8.71877 0.0589049 8.7383 0.0530909 8.75227C0.0501837 8.75926 0.0478833 8.76486 0.0461847 8.76902C0.0453354 8.7711 0.0446365 8.77283 0.0440875 8.77419C0.0438129 8.77487 0.0435758 8.77546 0.0433761 8.77595C0.0432763 8.7762 0.0431543 8.7765 0.0431045 8.77663C0.0429921 8.77691 0.0428889 8.77717 0.599976 9ZM8.99996 3.6C11.7768 3.6 13.7266 4.98208 15.004 6.40138C15.6431 7.1115 16.1062 7.82365 16.4092 8.35831C16.5604 8.62504 16.6707 8.84594 16.7424 8.99804C16.7782 9.07404 16.8044 9.13272 16.821 9.17118C16.8294 9.19041 16.8353 9.20457 16.839 9.2133C16.8408 9.21767 16.842 9.22068 16.8427 9.22228C16.843 9.22308 16.8432 9.22354 16.8432 9.22363C16.8432 9.22368 16.8432 9.22364 16.8432 9.2235C16.8431 9.22344 16.8431 9.22327 16.8431 9.22324C16.843 9.22305 16.8429 9.22284 17.4 9C17.9571 8.77716 17.957 8.77691 17.9568 8.77663C17.9568 8.7765 17.9567 8.7762 17.9566 8.77595C17.9564 8.77545 17.9561 8.77486 17.9559 8.77418C17.9553 8.77283 17.9546 8.7711 17.9538 8.76902C17.9521 8.76486 17.9498 8.75926 17.9469 8.75227C17.941 8.7383 17.9328 8.71877 17.9221 8.69405C17.9007 8.64462 17.8694 8.5744 17.8278 8.48633C17.7449 8.31031 17.6208 8.06246 17.4532 7.76669C17.1187 7.17635 16.6068 6.3885 15.8959 5.59862C14.4733 4.01792 12.2231 2.4 8.99996 2.4V3.6ZM17.4 9C16.8429 8.77716 16.843 8.77695 16.8431 8.77676C16.8431 8.77673 16.8431 8.77656 16.8432 8.7765C16.8432 8.77637 16.8432 8.77632 16.8432 8.77637C16.8432 8.77646 16.843 8.77692 16.8427 8.77772C16.842 8.77932 16.8408 8.78233 16.839 8.7867C16.8353 8.79543 16.8294 8.80959 16.821 8.82882C16.8044 8.86728 16.7782 8.92596 16.7424 9.00196C16.6707 9.15406 16.5604 9.37496 16.4092 9.64169C16.1062 10.1764 15.6431 10.8885 15.004 11.5986C13.7266 13.0179 11.7768 14.4 8.99996 14.4V15.6C12.2231 15.6 14.4733 13.9821 15.8959 12.4014C16.6068 11.6115 17.1187 10.8236 17.4532 10.2333C17.6208 9.93754 17.7449 9.68969 17.8278 9.51367C17.8694 9.4256 17.9007 9.35538 17.9221 9.30595C17.9328 9.28123 17.941 9.2617 17.9469 9.24773C17.9498 9.24074 17.9521 9.23514 17.9538 9.23098C17.9546 9.2289 17.9553 9.22718 17.9559 9.22582C17.9561 9.22514 17.9564 9.22455 17.9566 9.22405C17.9567 9.2238 17.9568 9.2235 17.9568 9.22337C17.957 9.22309 17.9571 9.22284 17.4 9ZM8.99998 10.8C8.00586 10.8 7.19998 9.99411 7.19998 9H5.99998C5.99998 10.6569 7.34312 12 8.99998 12V10.8ZM10.8 9C10.8 9.99411 9.99409 10.8 8.99998 10.8V12C10.6568 12 12 10.6569 12 9H10.8ZM8.99998 7.2C9.99409 7.2 10.8 8.00589 10.8 9H12C12 7.34315 10.6568 6 8.99998 6V7.2ZM8.99998 6C7.34312 6 5.99998 7.34315 5.99998 9H7.19998C7.19998 8.00589 8.00586 7.2 8.99998 7.2V6Z"
                      fill="#626262"/>
                  </svg>
                  Preview
                </button>
                <button class="btn btn-dark" (click)="exportToPDF()">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M0.600098 0V5.4C0.600098 6.72548 1.67461 7.8 3.0001 7.8C4.32558 7.8 5.4001 6.72548 5.4001 5.4V1.8C5.4001 1.13726 4.86284 0.6 4.2001 0.6C3.53736 0.6 3.0001 1.13726 3.0001 1.8V6M7.2001 0.6H15.0001C15.6628 0.6 16.2001 1.13726 16.2001 1.8V16.2C16.2001 16.8627 15.6628 17.4 15.0001 17.4H3.0001C2.33736 17.4 1.8001 16.8627 1.8001 16.2V9.6M13.2001 5.4H8.4001M13.2001 9H8.4001M13.2001 12.6H4.8001"
                      stroke="white" stroke-width="1.2"/>
                  </svg>
                  Export
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-body">
          <!-- Section 1: General Information -->
          <div id="section1" data-section="section1" class="fb-title-div ft-bg5 d-flex justify-content-between align-items-center px-3">
            <h4 class="mb-0">1. General Information</h4>
          </div>
          <div class="fb-form">
            <div class="row">
              <div class="col-sm-12 col-md-12">
                <div class="form-group mb-3">
                  <label>Title of Info Note*</label>
                  <div class="form-control-plaintext">{{ paperInfo?.paperProvision || 'N/A' }}</div>
                </div>
              </div>
              <div class="col-sm-12 col-md-12">
                <div class="form-group mb-3">
                  <label>What is the info note for?*</label>
                  <div class="form-control-plaintext" [innerHTML]="paperInfo?.purposeRequired || 'N/A'"></div>
                </div>
              </div>
              <div class="col-sm-6 col-md-4">
                <div class="form-group mb-3">
                  <label>CGB Item Ref</label>
                  <div class="form-control-plaintext">{{ paperInfo?.cgbItemRefNo || 'N/A' }}</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-4">
                <div class="form-group mb-3">
                  <label>Reference Number*</label>
                  <div class="form-control-plaintext">{{ paperInfo?.referenceNo || 'N/A' }}</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-4">
                <div class="form-group mb-3">
                  <label>CGB Circulation Date</label>
                  <div class="form-control-plaintext">{{ paperInfo?.cgbCirculationDate || 'N/A' }}</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-12">
                <div class="form-group mb-3">
                  <label>PSA/JV*</label>
                  <div class="form-control-plaintext">{{ paperInfo?.psajv || 'N/A' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 2: Cost Allocation and JV Approval -->
          <div id="section2" data-section="section2" class="fb-title-div ft-bg5 d-flex justify-content-between align-items-center px-3">
            <h4 class="mb-0">2. Cost Allocation & JV Approval</h4>
          </div>
          <div class="fb-form">
            <div class="cost-table-div custom-table table-responsive">
              <table class="table table-bordered">
                <thead>
                <tr>
                  <th>PSA</th>
                  <th *ngFor="let psa of getSelectedPSAJVColumns()">
                    <div class="form-check-list d-flex gap-3 flex-wrap">
                      <div class="form-check-box position-relative">
                        <input type="checkbox" [checked]="getPSACheckboxValue(psa)" disabled>
                        <label>{{ psa }}</label>
                      </div>
                    </div>
                  </th>
                  <th>
                    <b>Total</b>
                  </th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td><b>As%</b></td>
                  <td *ngFor="let psa of getSelectedPSAJVColumns()">
                    <label>{{ getPSAPercentageValue(psa) | number:'1.2-2' || '0.00' }}%</label>
                  </td>
                  <td>
                    <label>{{ getTotalPercentage() | number:'1.2-2' || '0.00' }}%</label>
                  </td>
                </tr>

                <tr>
                  <td><b>By value $</b></td>
                  <td *ngFor="let psa of getSelectedPSAJVColumns()">
                    <label>{{ getPSAValueValue(psa) | number:'1.2-2' || '0.00' }}</label>
                  </td>
                  <td>
                    <label>{{ getTotalValue() | number:'1.2-2' || '0.00' }}</label>
                  </td>
                </tr>

                <tr>
                  <td><b>1st Committee</b></td>
                  <td *ngFor="let psa of getSelectedPSAJVColumns()">
                    <div *ngIf="hasFirstCommitteeCheckbox(psa)" class="form-check-list d-flex gap-3 flex-wrap">
                      <div class="form-check-box position-relative">
                        <input type="checkbox" [checked]="getFirstCommitteeValue(psa)" disabled>
                        <label>{{ getFirstCommitteeLabel(psa) }}</label>
                      </div>
                    </div>
                  </td>
                  <td></td>
                </tr>

                <tr>
                  <td><b>2nd Committee</b></td>
                  <td *ngFor="let psa of getSelectedPSAJVColumns()">
                    <div *ngIf="hasSecondCommitteeCheckbox(psa)" class="form-check-list d-flex gap-3 flex-wrap">
                      <div class="form-check-box position-relative">
                        <input type="checkbox" [checked]="getSecondCommitteeValue(psa)" disabled>
                        <label>{{ getSecondCommitteeLabel(psa) }}</label>
                      </div>
                    </div>
                  </td>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Section 3: Consultation -->
          <div id="section3" data-section="section3" class="fb-title-div ft-bg5 d-flex justify-content-between align-items-center px-3">
            <h4 class="mb-0">3. Consultation</h4>
          </div>
          <div class="fb-form">
            <div class="overflow-auto">
              <div class="key-risks-table custom-table">
                <table class="table">
                  <thead>
                  <tr>
                    <th>PSA</th>
                    <th>Technically Correct</th>
                    <th>Budget Statement</th>
                    <th>JV Review</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let consultation of consultationsDetails">
                    <td>{{ consultation.psa || 'N/A' }}</td>
                    <td>{{ getDisplayName(consultation.technicalCorrectId) || 'N/A' }}</td>
                    <td>{{ getDisplayName(consultation.budgetStatementId) || 'N/A' }}</td>
                    <td>{{ getDisplayName(consultation.jvReviewId) || 'N/A' }}</td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Section 4: Attachments -->
          <div id="section4" data-section="section4" class="fb-title-div ft-bg5 d-flex justify-content-between align-items-center px-3">
            <h4 class="mb-0">4. Attachments</h4>
          </div>
          <div class="fb-form">
            <div class="form-group mb-3">
              <div class="mb-2">
                <label>Supporting Documents:</label>
              </div>
              <div class="document-attachment">
                <div class="image-slider">
                  <div class="slider-container">
                    <div class="attach-thumb bg-white slider-item" *ngFor="let file of selectedFiles">
                      <img *ngIf="file.preview && file.isImage" [src]="file.preview" alt="Document Image" class="uploaded-image"/>
                      <img *ngIf="file.preview && !file.isImage" [src]="'/img/bill.png'" alt="Document Image" class="uploaded-image"/>
                      <div class="file-info d-flex justify-content-between align-items-center">
                        <p class="m-0 file-name">{{ file.name }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

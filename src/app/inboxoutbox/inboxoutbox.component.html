<!-- Toasts Container -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <ngb-toast
    *ngFor="let toast of toastService.toasts"
    [class]="'bg-' + toast.type +' text-white'"
    [autohide]="true"
    [delay]="5000"
    (hidden)="toastService.remove(toast)"
  >
    {{ toast.message }}
  </ngb-toast>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="page-card-div position-relative">
        <!-- Loading Overlay -->
        <div *ngIf="isLoading" class="loading-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background-color: rgba(255, 255, 255, 0.95); z-index: 1000; min-height: 500px; border-radius: 12px;">
          <div class="table-loader">
            <div class="spinner"></div>
            <p>Loading inbox and outbox data...</p>
          </div>
        </div>
        <!-- Content - Hidden while loading -->
        <div [style.display]="isLoading ? 'none' : 'block'">

        <div class="row row-gap-3">
          <div class="col-md-5">
            <div class="custom-nav-div">
              <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav-tabs">
                <li [ngbNavItem]="1">
                  <button ngbNavLink>Inbox <span>{{ filteredInboxData.length }}</span></button>
                  <ng-template ngbNavContent>
                    <div class="inbox-col">
                      <div class="inbox-body">
                        <div class="row mt-1" >
                          <div class="col-md-6 col-lg-6 col-xl-3" *ngFor="let inbox of paginatedInboxData">
                            <div class="inbox-card cursor-pointer" (click)="gotoPaper(inbox.paperID, inbox.paperType)">
                              <h5 class="mb-0">{{ inbox.paperProvision }}</h5>
                              <div>
                                <span [ngClass]="getStatusClass(inbox.paperStatus)">{{ inbox.paperStatus }}</span>
                              </div>
                              <p>Paper Type · {{ inbox.paperType }}</p>
                              <p>
                                Last Updated · {{ inbox.paperLastModifyDate | date: 'dd-MMM-YYYY, hh:mm a' }}
                              </p>
                              <hr class="my-2" *ngIf="hasActionButtons(inbox)">
                              <div class="ic-btn-div d-flex justify-content-end gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-sm" 
                                        (click)="goToPreview(inbox); $event.stopPropagation()">
                                  Preview
                                </button>
                              </div>
                              <div class="ic-btn-div d-flex justify-content-end" [routerLink]="['/cgb-voting']"
                                   *ngIf="(loggedInUser?.roleName === 'CGB Chair' || loggedInUser?.roleName === 'CPO' || loggedInUser?.roleName === 'JV Admin' || loggedInUser?.roleName === 'Legal VP-1'|| loggedInUser?.roleName === 'Performance Manager' || loggedInUser?.roleName === 'Legal VP'  || loggedInUser?.roleName === 'PHCA'  || loggedInUser?.roleName === 'BLT') && inbox.paperStatus === 'On CGB'"
                                   (click)="$event.stopPropagation()">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3">
                                  Vote Now
                                </button>
                              </div>
                              <button class="btn btn-primary" type="button" (click)="updateProject(inbox.paperID, inbox.paperStatusId, 4); $event.stopPropagation()"
                                      *ngIf="(loggedInUser?.roleName === 'Procurement Tag' || loggedInUser?.roleName === 'CAM') && ((inbox.paperStatus === 'Registered'))">
                                Send For PDM Approval
                              </button>
                   
                              <div class="ic-btn-div d-flex justify-content-end"
                                   *ngIf="loggedInUser?.roleName === 'PDM' && (inbox.paperStatus === 'Waiting for PDM' || inbox.paperStatus === 'Action Required by Pre-CGB')">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3"
                                        (click)="open($event, content3, inbox.paperID); $event.stopPropagation()">
                                  Return to Originator
                                </button>
                              </div>
                              <div class="ic-btn-div d-flex justify-content-end"
                                   *ngIf="loggedInUser?.roleName === 'PDM' && (inbox.paperStatus === 'Waiting for PDM' || inbox.paperStatus === 'Action Required by Pre-CGB')">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3"
                                        (click)="open($event, content2, inbox.paperID); $event.stopPropagation()">
                                  Approve
                                </button>
                              </div>
                              <div class="ic-btn-div d-flex justify-content-end" *ngIf="
                      (loggedInUser?.roleName === 'CGB Chair' ||
                        loggedInUser?.roleName === 'CPO' ||
                        loggedInUser?.roleName === 'JV Admin' ||
                        loggedInUser?.roleName === 'Legal VP-1' ||
                        loggedInUser?.roleName === 'Performance Manager') &&
                      inbox.paperStatus === 'On Pre-CGB'
                    ">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3"
                                        (click)="open($event, content4, inbox.paperID); $event.stopPropagation()">
                                  Add Review
                                </button>
                              </div>
                              <div class="ic-btn-div d-flex justify-content-end"
                                   *ngIf="loggedInUser?.roleName === 'Procurement Tag' && inbox.paperStatus === 'Action Required by CGB'">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3"
                                        (click)="updateProject(inbox.paperID, inbox.paperStatusId); $event.stopPropagation()">
                                  Return to requested
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Pagination for Inbox -->
                      <div class="pagination-wrapper mt-4" *ngIf="getTotalPagesInbox() > 1">
                        <div class="d-flex justify-content-between align-items-center">
                          <div class="pagination-info">
                            <span class="text-muted">
                              Showing {{ (currentPageInbox - 1) * itemsPerPage + 1 }} - 
                              {{ currentPageInbox * itemsPerPage > filteredInboxData.length ? filteredInboxData.length : currentPageInbox * itemsPerPage }} 
                              of {{ filteredInboxData.length }} items
                            </span>
                          </div>
                          <div class="pagination-controls d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    (click)="prevPageInbox()" 
                                    [disabled]="currentPageInbox === 1">
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                            <div class="d-flex gap-1">
                              <button *ngFor="let page of getPageNumbersInbox()" 
                                      class="btn btn-sm"
                                      [class.btn-primary]="page === currentPageInbox"
                                      [class.btn-outline-secondary]="page !== currentPageInbox"
                                      (click)="goToPageInbox(page)">
                                {{ page }}
                              </button>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    (click)="nextPageInbox()" 
                                    [disabled]="currentPageInbox === getTotalPagesInbox()">
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </li>
                <li [ngbNavItem]="2">
                  <button ngbNavLink>Outbox <span>{{ filteredOutboxData.length }}</span></button>
                  <ng-template ngbNavContent>
                    <div class="inbox-col">
                      <div class="inbox-body">
                        <div class="row mt-1">
                          <div class="col-md-6 col-lg-6 col-xl-3" *ngFor="let outbox of paginatedOutboxData">
                            <div class="inbox-card mb-3 cursor-pointer"
                                 (click)="gotoPaper(outbox.paperID, outbox.paperType)">
                              <h5 class="mb-0">{{ outbox.paperProvision }}</h5>
                              <div>
                                <span [ngClass]="getStatusClass(outbox.paperStatus)">{{ outbox.paperStatus }}</span>
                              </div>
                              <p *ngIf="outbox.paperType">Paper Type
                                · {{ outbox.paperType }}</p>
                              <hr class="my-2">
                              <div class="ic-btn-div d-flex justify-content-end gap-2 mb-2">
                                <button class="btn btn-outline-primary btn-sm" 
                                        (click)="goToPreview(outbox); $event.stopPropagation()">
                                  Preview
                                </button>
                              </div>
                              <div class="ic-btn-div d-flex justify-content-end gap-3">
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3">
                                  History
                                </button>
                                <button class="btn btn-outline-secondary d-flex align-items-center gap-3"
                                        (click)="exportToPDF(outbox.paperID, $event)"
                                        [disabled]="isDownloading(outbox.paperID)">
                                  <span *ngIf="!isDownloading(outbox.paperID)">Download</span>
                                  <span *ngIf="isDownloading(outbox.paperID)" class="d-flex align-items-center gap-2">
                                    Downloading...
                                  </span>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- Pagination for Outbox -->
                      <div class="pagination-wrapper mt-4" *ngIf="getTotalPagesOutbox() > 1">
                        <div class="d-flex justify-content-between align-items-center">
                          <div class="pagination-info">
                            <span class="text-muted">
                              Showing {{ (currentPageOutbox - 1) * itemsPerPage + 1 }} - 
                              {{ currentPageOutbox * itemsPerPage > filteredOutboxData.length ? filteredOutboxData.length : currentPageOutbox * itemsPerPage }} 
                              of {{ filteredOutboxData.length }} items
                            </span>
                          </div>
                          <div class="pagination-controls d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-sm" 
                                    (click)="prevPageOutbox()" 
                                    [disabled]="currentPageOutbox === 1">
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                            <div class="d-flex gap-1">
                              <button *ngFor="let page of getPageNumbersOutbox()" 
                                      class="btn btn-sm"
                                      [class.btn-primary]="page === currentPageOutbox"
                                      [class.btn-outline-secondary]="page !== currentPageOutbox"
                                      (click)="goToPageOutbox(page)">
                                {{ page }}
                              </button>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    (click)="nextPageOutbox()" 
                                    [disabled]="currentPageOutbox === getTotalPagesOutbox()">
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </li>
              </ul>
            </div>
          </div>
          <ng-template #noDataFound>
            <li>
              No Data found
            </li>
          </ng-template>
          <div class="col-md-7">
            <div class="filter-head d-flex justify-content-end gap-3 mb-4">
              <div class="fh-search">
                <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M16 14H15.21L14.93 13.73C15.91 12.59 16.5 11.11 16.5 9.5C16.5 5.91 13.59 3 10 3C6.41 3 3.5 5.91 3.5 9.5C3.5 13.09 6.41 16 10 16C11.61 16 13.09 15.41 14.23 14.43L14.5 14.71V15.5L19.5 20.49L20.99 19L16 14ZM10 14C7.51 14 5.5 11.99 5.5 9.5C5.5 7.01 7.51 5 10 5C12.49 5 14.5 7.01 14.5 9.5C14.5 11.99 12.49 14 10 14Z"
                        fill="#84818A"/>
                </svg>
                <input class="form-control" 
                       placeholder="Search Field"
                       [(ngModel)]="searchTerm"
                       (input)="onSearchChange()"/>
              </div>
              <div ngbDropdown class="filter-btn-div" #dropdownRef="ngbDropdown" [autoClose]="'outside'" (openChange)="onFilterDropdownOpen()">
                <button class="btn d-flex gap-2 align-items-center"
                        [ngClass]="isFilterApplied ? 'create-btn' : 'btn-outline-secondary'"
                        ngbDropdownToggle>
                  <svg width="20" height="15" viewBox="0 0 20 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                          d="M7 11.8515V14.0515H13V11.8515H7ZM4 6.35146V8.55147H16V6.35146H4ZM0 0.851562V3.05156H20V0.851562H0Z"
                          fill="#898989" />
                  </svg>
                  Filter
                </button>

                <div class="filter-dropdown-div" ngbDropdownMenu aria-labelledby="dropdownBasic1">
                  <!-- Header -->
                  <div class="flt-head d-flex justify-content-between align-items-center p-2 border-bottom">
                    <h5 class="mb-0">Filter</h5>
                    <button type="button" class="btn-close" aria-label="Close" (click)="cancelFilters()"></button>
                  </div>

                  <div class="flt-body">
                    <!-- Status Filter -->
                    <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                      <label class="text-secondary mb-0">Status</label>
                      <a href="#" class="text-primary small" (click)="clearStatusFilter(); $event.preventDefault()">Clear</a>
                    </div>

                    <div class="mb-3">
                      <select class="form-select" [(ngModel)]="filterStatus" (change)="onFilterChange()">
                        <option value="">All Statuses</option>
                        <option *ngFor="let status of getUniqueStatuses()" [value]="status">{{ status }}</option>
                      </select>
                    </div>

                    <!-- Paper Type Filter -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="text-secondary mb-0">Paper Type</label>
                      <a href="#" class="text-primary small" (click)="clearPaperTypeFilter(); $event.preventDefault()">Clear</a>
                    </div>

                    <div class="mb-3">
                      <select class="form-select" [(ngModel)]="filterPaperType" (change)="onFilterChange()">
                        <option value="">All Types</option>
                        <option *ngFor="let type of getUniquePaperTypes()" [value]="type">{{ type }}</option>
                      </select>
                    </div>

                    <!-- Footer Buttons -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <button class="btn btn-sm w-100" (click)="clearFilters()">Clear All</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
             
            
              <div class="filter-btn-div">
                <button class="btn btn-outline-secondary d-flex gap-2 align-items-center"
                        (click)="toggleSort()">
                  <svg width="9" height="24" viewBox="0 0 9 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M0.450271 8.45H8.5505C8.63251 8.4497 8.7129 8.42386 8.78301 8.37524C8.85312 8.32662 8.91031 8.25707 8.9484 8.17408C8.9865 8.09108 9.00406 7.99779 8.99921 7.90423C8.99436 7.81068 8.96727 7.72041 8.92086 7.64314L4.87075 0.957886C4.70289 0.680705 4.29878 0.680705 4.13048 0.957886L0.0803605 7.64314C0.0334803 7.72025 0.00598872 7.81056 0.000872541 7.90427C-0.00424364 7.99798 0.0132113 8.0915 0.0513409 8.17467C0.0894705 8.25784 0.146816 8.32748 0.217148 8.37602C0.28748 8.42456 0.368108 8.45015 0.450271 8.45Z"
                      fill="#898989"/>
                    <path
                      d="M0.450271 14.45H8.5505C8.63251 14.4503 8.7129 14.4799 8.78301 14.5354C8.85312 14.591 8.91031 14.6705 8.9484 14.7653C8.9865 14.8602 9.00406 14.9668 8.99921 15.0737C8.99436 15.1807 8.96727 15.2838 8.92086 15.3721L4.87075 23.0124C4.70289 23.3292 4.29878 23.3292 4.13048 23.0124L0.0803605 15.3721C0.0334803 15.284 0.00598872 15.1808 0.000872541 15.0737C-0.00424364 14.9666 0.0132113 14.8597 0.0513409 14.7647C0.0894705 14.6696 0.146816 14.59 0.217148 14.5345C0.28748 14.4791 0.368108 14.4498 0.450271 14.45Z"
                      fill="#898989"/>
                  </svg>
                  {{ isDesc ? 'Z A' : 'A Z' }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div [ngbNavOutlet]="nav" class="mt-2"></div>
        </div> <!-- End of content wrapper -->
      </div>
    </div>
  </div>
</div>

<ng-template #content2 let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Approve Paper</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="form-group mb-3">
      <label>Write Comment (If Required)</label>
      <textarea
        class="form-control"
        placeholder="Write here"
        [(ngModel)]="approvalRemark"
      ></textarea>
    </div>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-primary"
      (click)="approvePaper(modal, 'Approval')"
      [disabled]="isApproving"
    >
      <span *ngIf="!isApproving">Approve</span>
      <span *ngIf="isApproving">Approving...</span>
    </button>
  </div>
</ng-template>

<ng-template #content3 let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Return to Originator</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="form-group mb-3">
      <label>Review By</label>
      <input
        class="form-control"
        type="text"
        placeholder="Write here"
        [(ngModel)]="reviewBy"
      />
    </div>
    <div class="form-group mb-3">
      <label>Write Comment</label>
      <textarea
        class="form-control"
        placeholder="Write here"
        [(ngModel)]="approvalRemark"
      ></textarea>
    </div>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-primary"
      (click)="approvePaper(modal, 'Return to Originator')"
    >
      Save
    </button>
  </div>
</ng-template>

<ng-template #content4 let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Remark</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div class="form-group mb-3">
      <label>Write Comment</label>
      <textarea
        class="form-control"
        placeholder="Write here"
        [(ngModel)]="approvalRemark"
      ></textarea>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary" (click)="addReview(modal)">
      Add comment
    </button>
  </div>
</ng-template>
